name: Update FF14 Skills Data

# å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®š
on:
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆGitHubã® Actions ã‚¿ãƒ–ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:
    inputs:
      job_name:
        description: 'FF14 Job name (e.g., paladin, warrior, dark_knight)'
        required: true
        default: 'paladin'
        type: choice
        options:
          - paladin
          - warrior  
          - dark_knight
          - white_mage
          - black_mage
          
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯Žé€±æ—¥æ›œæ—¥ 0æ™‚ã«å®Ÿè¡Œï¼‰
  schedule:
    - cron: '0 0 * * 0'

# å®Ÿè¡Œæ¨©é™è¨­å®š
permissions:
  contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™
  actions: read    # Actionsèª­ã¿å–ã‚Šæ¨©é™

jobs:
  update-skills:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: scripts/package.json
        
    # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        cd scripts
        npm install
        
    # 4. Chrome WebDriverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPuppeteerç”¨ï¼‰
    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest
      
    # 5. ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    - name: Run FF14 skills scraper
      run: |
        cd scripts
        node scrape_ff14_skills.js --job ${{ github.event.inputs.job_name || 'paladin' }} --verbose --output ../data
      env:
        JOB_NAME: ${{ github.event.inputs.job_name || 'paladin' }}
        
    # 6. ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
    - name: Commit updated skills data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/*.json
        
        # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ”„ Update FF14 ${{ github.event.inputs.job_name || 'paladin' }} skills data - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    # 7. çµæžœã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - name: Create summary
      run: |
        echo "## ðŸ“Š FF14 Skills Update Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Job**: ${{ github.event.inputs.job_name || 'paladin' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "data/${{ github.event.inputs.job_name || 'paladin' }}_skills.json" ]; then
          SKILL_COUNT=$(cat "data/${{ github.event.inputs.job_name || 'paladin' }}_skills.json" | jq '.skills | length')
          echo "- **Skills Count**: $SKILL_COUNT" >> $GITHUB_STEP_SUMMARY
        fi