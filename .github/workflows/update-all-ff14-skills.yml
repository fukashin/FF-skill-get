name: Update All FF14 Skills Data

# å…¨ã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚­ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æ›´æ–°ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
on:
  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆGitHubã® Actions ã‚¿ãƒ–ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:
    inputs:
      jobs:
        description: 'Jobs to scrape (comma-separated, leave empty for all)'
        required: false
        default: ''
        type: string
      delay:
        description: 'Delay between requests (milliseconds)'
        required: false
        default: '3000'
        type: string
        
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯Žæœˆ1æ—¥ 0æ™‚ã«å®Ÿè¡Œï¼‰
  schedule:
    - cron: '0 0 1 * *'

# å®Ÿè¡Œæ¨©é™è¨­å®š
permissions:
  contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™
  actions: read    # Actionsèª­ã¿å–ã‚Šæ¨©é™

jobs:
  update-all-skills:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: scripts/package.json
        
    # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        cd scripts
        npm install
        
    # 4. Chrome WebDriverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPuppeteerç”¨ï¼‰
    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest
      
    # 5. å…¨ã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    - name: Run FF14 all jobs scraper
      run: |
        cd scripts
        if [ -n "${{ github.event.inputs.jobs }}" ]; then
          node scrape_all_jobs.js --jobs "${{ github.event.inputs.jobs }}" --delay ${{ github.event.inputs.delay || '3000' }} --verbose --output ../data
        else
          node scrape_all_jobs.js --delay ${{ github.event.inputs.delay || '3000' }} --verbose --output ../data
        fi
      env:
        JOBS_INPUT: ${{ github.event.inputs.jobs }}
        DELAY_INPUT: ${{ github.event.inputs.delay || '3000' }}
        
    # 6. ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
    - name: Commit updated skills data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/*.json
        
        # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          if [ -n "${{ github.event.inputs.jobs }}" ]; then
            git commit -m "ðŸ”„ Update FF14 skills data for: ${{ github.event.inputs.jobs }} - $(date +'%Y-%m-%d %H:%M:%S')"
          else
            git commit -m "ðŸ”„ Update all FF14 skills data - $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          git push
        fi
        
    # 7. çµæžœã®é€šçŸ¥ã¨ã‚µãƒžãƒªãƒ¼ä½œæˆ
    - name: Create summary
      run: |
        echo "## ðŸ“Š FF14 All Skills Update Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **Delay**: ${{ github.event.inputs.delay || '3000' }}ms" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ github.event.inputs.jobs }}" ]; then
          echo "- **Target Jobs**: ${{ github.event.inputs.jobs }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Target Jobs**: All available jobs" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°çµ±è¨ˆã‚’è¡¨ç¤º
        if [ -f "data/all_ff14_skills.json" ]; then
          echo "### ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
          TOTAL_JOBS=$(cat "data/all_ff14_skills.json" | jq '.metadata.total_jobs')
          TOTAL_SKILLS=$(cat "data/all_ff14_skills.json" | jq '.metadata.total_skills')
          echo "- **Total Jobs Processed**: $TOTAL_JOBS" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Skills Scraped**: $TOTAL_SKILLS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Jobs Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat "data/all_ff14_skills.json" | jq -r '.metadata.jobs[] | "\(.job_display_name) (\(.job_name)): \(.skills_count) skills"' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        # å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚‚è¡¨ç¤º
        echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la data/*.json | awk '{print $9, $5"B"}' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY